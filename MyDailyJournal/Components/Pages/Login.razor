@page "/login"
@using MyDailyJournal.MauiBlazor.Services
@inject AuthenticationService AuthService
@inject NavigationManager Navigation

<PageTitle>Login - My Daily Journal</PageTitle>

<div class="login-container">
    <div class="login-card">
        <div class="text-center mb-4">
            <h1 style="font-size: 80px;">üìî</h1>
            <h2>My Daily Journal</h2>
            <p class="text-muted">@_subtitle</p>
        </div>

        <EditForm Model="@this" OnValidSubmit="@HandleLogin">
            <div class="mb-3">
                <label for="pin" class="form-label">PIN</label>
                <input type="password" 
                       class="form-control form-control-lg text-center" 
                       id="pin" 
                       @bind="_pin" 
                       maxlength="6"
                       placeholder="Enter 4-6 digit PIN"
                       style="font-size: 24px; letter-spacing: 10px;" />
            </div>

            
@if
 
(
!
string
.
IsNullOrEmpty
(
_errorMessage
)
)

            
{

                
<div
 
class
=
"
alert alert-danger
"
 
role
=
"alert"
>

                    
@_errorMessage

                
</div>

            
}


            <button type="submit" class="btn btn-primary btn-lg w-100">
                @_buttonText
            </button>
        </EditForm>

        <div class="text-center mt-4">
            <small class="text-muted">üí° Tip: Write every day to build your streak!</small>
        </div>
    </div>
</div>

@code
 
{

    
private
 
string
 _pin 
=
 
string
.
Empty
;

    
private
 
string
 _errorMessage 
=
 
string
.
Empty
;

    
private
 
bool
 _isFirstTimeSetup;

    
private
 
string
 _subtitle 
=
 
"Enter your PIN to unlock"
;

    
private
 
string
 _buttonText 
=
 
"UNLOCK JOURNAL üîì"
;


    
protected
 
override
 
async
 
Task
 
OnInitializedAsync
(
)

    
{

        _isFirstTimeSetup 
=
 
await
 AuthService
.
IsFirstTimeSetup
(
)
;

        
        
if
 
(
_isFirstTimeSetup
)

        
{

            _subtitle 
=
 
"Create your 4-6 digit PIN"
;

            _buttonText 
=
 
"CREATE PIN üîê"
;

        
}

    
}


    
private
 
async
 
Task
 
HandleLogin
(
)

    
{

        _errorMessage 
=
 
string
.
Empty
;

        
        
if
 
(
string
.
IsNullOrWhiteSpace
(
_pin
)
)

        
{

            _errorMessage 
=
 
"Please enter a PIN"
;

            
return
;

        
}


        
if
 
(
_isFirstTimeSetup
)

        
{

            
if
 
(
_pin
.
Length 
<
 
4
 
||
 _pin
.
Length 
>
 
6
)

            
{

                _errorMessage 
=
 
"PIN must be 4-6 digits"
;

                
return
;

            
}


            
var
 success 
=
 
await
 AuthService
.
CreatePin
(
_pin
)
;

            
if
 
(
success
)

            
{

                Navigation
.
NavigateTo
(
"/"
)
;

            
}

            
else

            
{

                _errorMessage 
=
 
"Failed to create PIN. Please try again."
;

            
}

        
}

        
else

        
{

            
var
 isValid 
=
 
await
 AuthService
.
ValidatePin
(
_pin
)
;

            
if
 
(
isValid
)

            
{

                Navigation
.
NavigateTo
(
"/"
)
;

            
}

            
else

            
{

                _errorMessage 
=
 
"‚ùå Incorrect PIN. Try again!"
;

                _pin 
=
 
string
.
Empty
;

            
}

        
}

    
}

}


<style>
    .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #673AB7 0%, #9C27B0 100%);
    }

    .login-card {
        background: white;
        border-radius: 20px;
        padding: 40px;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .form-control:focus {
        border-color: #673AB7;
        box-shadow: 0 0 0 0.2rem rgba(103, 58, 183, 0.25);
    }

    .btn-primary {
        background-color: #673AB7;
        border-color: #673AB7;
    }

    .btn-primary:hover {
        background-color: #5E35B1;
        border-color: #5E35B1;
    }
</style>